<?php
/*
 * foss_type
 * lab_migration_proposal -> university
 * textbook_companion_proposal
 * workshop
 * selfworkshop,events_training,events_academiccenter,events_city,events_state
 *
 */
// https://docs.google.com/document/d/1wZ4iLe92_w6UjKk_eC34A6x1X3NRC32ywiiYo0E6f04/edit?usp=sharing
// function fossee_institute_permission(){
//     return array(
//         "print_workshop" => array(
//             "title" => t("View Workshop"),
//             "description" => t("Allows users to view workshop.")
//         )
//     );
// }
function fossee_institute_profiles_menu(){
    $menu = array();
    $menu['cProfiles'] = array(
        'title'=>'College Profiles',
        'description'=>'College Profile',
        'page callback'=>'fossee_institute_profiles_page',
        'access callback'=>true
    );
    $menu['workshop/view'] = array(
        "title" => "Workshop",
        "page callback" => "fossee_institute_profiles_workshop",
        "access arguments" => array(
            "vieww"
        ),
        'access callback'=>true,
        "type" => MENU_CALLBACK
    );
    return $menu;
}
function fossee_institute_profiles_workshop($wid = 0){
    // $str = 'SELECT * FROM workshop WHERE w_id='.$wid;
    // dpm($str);
    $out = '';
    $query = db_query('SELECT * FROM workshop WHERE w_id = :args',array(':args'=>$wid));
    $rows = $query->fetchAll();
    
    return $out;
}

function fossee_institute_profiles_display($val){
    $lab = '';  // Lab Migration Html
    $state = ''; // State of the colege
    $country = ''; // Country of the college
    $city = ''; // City of the college
    $work = ''; // Worshop html
    $text = ''; // Text book html
    $i = 1; // Increnet variable
    $query = db_query('SELECT * FROM workshop WHERE venue LIKE :args;',array(':args'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    $Fpage = drupal_get_normal_path(url()); // Get the front url

    foreach($rows as $row){
        $work .= '<a href="'.$Fpage.'workshop/view/'.$row->w_id.'" target="_blank">'.$i.' > '.$row->w_name.'</a><br>';
        $i++;
    }
    // Lab Migration Proposal
    $i = 1;
    $query = db_query('SELECT * FROM scilab.lab_migration_proposal WHERE university LIKE :arg',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $lab .= '<a href="http://scilab.in/lab_migration_run/'.$row->id.'" target="_blank">'.$i.' > '.$row->lab_title.'</a><br>';
        if(IS_EMPTY($state))    $state = $row->state;
        if(IS_EMPTY($city))     $city = $row->city;
        if(IS_EMPTY($country))  $country = $row->country;    
        $i++;
    }

    $query = db_query('SELECT * FROM esim.lab_migration_proposal WHERE university LIKE :arg',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $lab .= '<a href="http://esim.fossee.in/lab_migration_run/'.$row->id.'" target="_blank">'.$i.' > '.$row->lab_title.'</a><br>';
        if(IS_EMPTY($state))    $state = $row->state;
        if(IS_EMPTY($city))     $city = $row->city;
        if(IS_EMPTY($country))  $country = $row->country;
        $i++;
    }
    $query = db_query('SELECT * FROM openmodelica.lab_migration_proposal WHERE university LIKE :arg',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $lab .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->lab_title.'</a><br>';
        if(IS_EMPTY($state))    $state = $row->state;
        if(IS_EMPTY($city))     $city = $row->city;
        if(IS_EMPTY($country))  $country = $row->country;
        $i++;
    }
    $query = db_query('SELECT * FROM dwsim_2015.lab_migration_proposal WHERE university LIKE :arg',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $lab .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->lab_title.'</a><br>';
        if(IS_EMPTY($state))    $state = $row->state;
        if(IS_EMPTY($city))     $city = $row->city;
        if(IS_EMPTY($country))  $country = $row->country;
        $i++;
    }
    $query = db_query('SELECT * FROM cfd_2015.lab_migration_proposal WHERE university LIKE :arg',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $lab .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->lab_title.'</a><br>';
        if(IS_EMPTY($state))    $state = $row->state;
        if(IS_EMPTY($city))     $city = $row->city;
        if(IS_EMPTY($country))  $country = $row->country;
        $i++;
    }

    /***************************** Text book********************* */
    $i = 1;
    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM scilab.textbook_companion_proposal po left join scilab.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }
    
    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM esim.textbook_companion_proposal po left join esim.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }
    
    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM dwsim_2015.textbook_companion_proposal po left join dwsim_2015.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }
    
    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM openmodelica.textbook_companion_proposal po left join openmodelica.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }

    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM cfd_2015.textbook_companion_proposal po left join cfd_2015.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }

    $query = db_query('SELECT pe.book as book,pe.author as author,pe.id as id FROM or_fossee.textbook_companion_proposal po left join or_fossee.textbook_companion_preference pe on po.id = pe.id WHERE university LIKE :arg AND pe.id IS NOT NULL',array(':arg'=>'%'.$val.'%'));
    $rows = $query->fetchAll();
    foreach($rows as $row){
        $text .= '<a href="'.$row->id.'" target="_blank">'.$i.' > '.$row->book.' By '.$row->author.'</a><br>';
        $i++;
    }
    /*********************************** Display Data */
    if(IS_EMPTY($state)) $state = "----";
    if(IS_EMPTY($city)) $city = "----";
    if(IS_EMPTY($country)) $country = "----";

    $out .= '<div id="cProfile">';
    $out .= '<label id="cName">'.$val.'</label><br>';
    $out .= '( <b>Country</b> : '.$country;
    $out .= '&nbsp;&nbsp;<b>State</b> : '.$state;
    $out .= '&nbsp;&nbsp;<b>City</b> : '.$city.' )';
    $out .= '<br><label>Lab Migration</label><br>';
    if($lab != '')
        $out .= $lab;
    else $out .= 'No Lab migration Done!<br>';
    $out .= '<label>Textbook Companion</label><br>';
    if($text != '')
        $out .= $text;
    else $out .= "No Textbook Companion!<br>";
    $out .= '<label>Workshops</label><br>';
    if($work != '')
        $out .= $work;
    else $out .= 'No Workshop Done!';
    $out .= '</div>';
    return $out;
}

// Check Wether it The string is empty , none or 0
function IS_EMPTY($val){
    return ($val === '' || $val === 'None' || $val === '0');
}

function fossee_institute_profiles_page(){
    drupal_add_js(drupal_get_path('module','fossee_institute_profiles').'/fossee_profiles.js');
    drupal_add_css(drupal_get_path('module','fossee_institute_profiles').'/fossee_profiles.css');
    
    if(isset($_GET['c'])){
        return fossee_institute_profiles_display(str_replace('-',' ',$_GET['c']));
    }
        
    $tmp = '<b>Enter The College Name :</b><br>';
    $tmp .= '<input type="text" id="clgName" onkeyup="AddTOList(this)" keydown="clearSgst(event)">';
    $tmp .= '<input type="submit" onclick="search()" value="Q"/>';
    db_set_active('Scilab');
    $query = db_query('SELECT DISTINCT university FROM lab_migration_proposal;');
    $rows = $query->fetchAll();
    $tmp .= '<script> var sci_lab_m = '.json_encode($rows).'</script>';
    
    $query = db_query('SELECT DISTINCT university FROM textbook_companion_proposal;');
    $rows = $query->fetchAll();
    $tmp .= '<script> var sci_lab_text = '.json_encode($rows).'</script>';

    $tmp .= '<div id="suggest"></div>';
    return $tmp;
}